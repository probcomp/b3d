name: pdoc

on:
  pull_request:
  push:
    branches:
      - eightysteele/gen-450-create-docs-environment-that-doesnt-require-gpu
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.ARTIFACT_REGISTRY_KEY }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: pixi run docs
        run: |
          # install pixi
          curl -fsSL https://pixi.sh/install.sh | bash
          export PATH=/home/runner/.pixi/bin:$PATH

          # install pipx and inject gcp backend
          pixi global install pipx
          pipx install keyring
          pipx inject keyring \
          keyrings.google-artifactregistry-auth \
            --index-url \
            https://pypi.org/simple

          # build docs
          pixi run docs

      - name: Prepend timestamp to index.html
        run: |
          echo "Published at: $(date)<br/>" | cat - ./docs/static/index.html > temp && mv temp ./docs/static/index.html

      - name: Create website artifact
        uses: actions/upload-artifact@v4
        with:
          name: website
          path: ./docs/static

  publish:
    needs: build-deploy
    uses: probcomp/gen-website-private/.github/workflows/publish_private_website.yml@main
    with:
      artifact: website
