name: pixi

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  pixi-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # - name: Checkout probcomp/datasync
      #   uses: actions/checkout@v4
      #   with:
      #     #token: ${{ secrets.GITHUB_TOKEN }}
      #     repository: probcomp/datasync
      #     ref: master
      #     path: datasync

      - name: Authenticate gcloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.ARTIFACT_REGISTRY_KEY }}"

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: pixi install locked
        run: |
          # install pixi
          curl -fsSL https://pixi.sh/install.sh | bash
          export PATH=/home/runner/.pixi/bin:/home/runner/.local/bin:$PATH
          source ~/.bashrc

          # install pipx and inject gcp backend
          pixi global install pipx
          pipx install keyring
          pipx inject keyring \
            keyrings.google-artifactregistry-auth \
            --index-url \
            https://pypi.org/simple

          # authenticate the read-only datasync package
          # the token is scoped for read only on this package
          # TODO: obviously move this into a ${{ secrets.XXX }}
          export PREFIX_API_KEY=pfx-Fa1uiLkyxMhvSdcHtwi7GdUpwtumLDqkE4hr
          pixi auth login prefix.dev --token $PREFIX_API_KEY

          # ensure all deps across all environments and platforms are solving
          pixi --version
          pixi clean && pixi clean cache --yes
          pixi install --locked -e default -v --pypi-keyring-provider subprocess
          pixi install --locked -e cpu -v --pypi-keyring-provider subprocess
          pixi install --locked -e gpu -v --pypi-keyring-provider subprocess
